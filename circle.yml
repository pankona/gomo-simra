machine:
    environment:
        IMPORT_PATH: "github.com/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME"
        GOROOT: "$HOME/goroot/go"
        GOPATH: "$HOME/go"
        NDK: "android-ndk-r15c"
        NDK_ROOT: "$HOME/$NDK"
        PATH: "$GOROOT/bin:$GOPATH/bin:$PATH"

dependencies:
    cache_directories:
        - $GOROOT
        - $GOPATH
        - $NDK_ROOT
        - ~/tmp

    pre:
        - sudo apt-get update; sudo apt-get install -y libegl1-mesa-dev libgles2-mesa-dev libx11-dev
        - |
            mkdir -p $GOPATH
            mkdir -p ~/tmp && cd ~/tmp
            if [ ! -e $GOROOT ]; then
                GOPKG=go1.9.linux-amd64.tar.gz
                wget https://storage.googleapis.com/golang/$GOPKG
                mkdir -p $GOROOT
                tar -xf $GOPKG
                cp -r ./go -T $GOROOT
            fi
            if [ ! -e $NDK_ROOT ]; then
                wget https://dl.google.com/android/repository/$NDK-linux-x86_64.zip
                unzip -q ./$NDK-linux-x86_64.zip
                mv ./$NDK $HOME/.
                ls $HOME
            fi
        - go get -u golang.org/x/mobile/cmd/gomobile
        - go get -u github.com/golang/freetype/truetype
        - go get -u github.com/boltdb/bolt
        - go get -u github.com/hajimehoshi/oto
        - go get -u github.com/hajimehoshi/go-mp3
        - go get -u github.com/golang/lint/golint
        - go get -u gopkg.in/alecthomas/gometalinter.v2
        - gometalinter.v2 --install --update
        - gomobile init --ndk $NDK_ROOT

    override:
        - echo "$GOPATH/src/$IMPORT_PATH"
        - mkdir -p "$GOPATH/src/$IMPORT_PATH"
        - rsync -azC --delete ./ "$GOPATH/src/$IMPORT_PATH/"
        - make -C "$GOPATH/src/$IMPORT_PATH/examples"
        - make -C "$GOPATH/src/$IMPORT_PATH/examples" BUILD_TAGS=release
        - make mobile -C "$GOPATH/src/$IMPORT_PATH/examples"
        - make mobile -C "$GOPATH/src/$IMPORT_PATH/examples" BUILD_TAGS=release

test:
    override:
        - cd "$GOPATH/src/$IMPORT_PATH/examples" && test -z "$(golint ./... | tee /dev/stderr)"
        - cd "$GOPATH/src/$IMPORT_PATH/simra"    && test -z "$(golint ./... | tee /dev/stderr)"
        - cd "$GOPATH/src/$IMPORT_PATH/simra"    && go test ./...
        - cd "$GOPATH/src/$IMPORT_PATH"          && make gometalinter
